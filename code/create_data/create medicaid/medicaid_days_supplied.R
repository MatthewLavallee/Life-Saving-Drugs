library(data.table)
library(tidyverse)
library(magrittr)
library(ipumsr)
library(here)

dir.create(here("trunk","derived","medicaid data"),showWarnings = F)
#should exist if running in order

dfs<-fread(here("trunk","derived","medicaid data","relevant_sdud.txt"))
xw<-dfs[,.(NDC,`Labeler Code`,`Product Code`,`Package Size`,`Product Name`,drug_class)][order(`Product Code`)]%>%unique()
  #pull unique ndcs
names(xw)<-c("ndc","lab_code","prod_code","pack_code","prod_name","drug_class")

xw[,`:=`(dose=case_when(prod_code==140~"100MG",
                       prod_code==141~"300MG",
                       prod_code==152~"10MG",
                       prod_code==153~"25MG",
                       prod_code==159~"16MG",
                       prod_code==164~"25MG/5MG",
                       prod_code==168~"12.5MG/1000MG",
                       prod_code==175~"12.5MG/1000MG",
                       prod_code==180~"12.5MG/500MG",
                       prod_code==182~"10MG/5MG",
                       prod_code==210~"5mcg",
                       prod_code==212~"10mcg",
                       prod_code==219~"2mg",
                       prod_code==280~"10mg/1000mg",
                       prod_code==290~"5mg/1000mg",
                       prod_code==295~"25mg/1000mg",
                       prod_code==300~"12.5/1000mg",
                       prod_code==380~"10mg/5mg/1000mg",
                       prod_code==385~"12.5mg/2.5mg/1000mg",
                       prod_code==390~"25mg/5mg/1000mg",
                       prod_code==395~"5mg/2.5mg/1000mg",
                       prod_code==540~"50mg/500mg",
                       prod_code==541~"50mg/1000mg",
                       prod_code==542~"150mg/500mg",
                       prod_code==543~"150mg/1000mg",
                       prod_code==940~"50mg/500mg",
                       prod_code==941~"50mg/1000mg",
                       prod_code==942~"150mg/500mg",
                       prod_code==943~"150mg/1000mg",
                       prod_code==1427~"5mg",
                       prod_code==1428~"10mg",
                       prod_code==1433~".75mg/.5ml",
                       prod_code==1434~"1.5mg/.5ml",
                       prod_code==2236~"3mg/.5ml",
                       prod_code==2800~"6mg",
                       prod_code==2911~"100ml/3.6mg",
                       prod_code==3182~"4.5mg/.5ml",
                       prod_code==4060~"6mg",
                       prod_code==4130~"1.34mg/ml",
                       prod_code==4132~"1.34mg/ml",
                       prod_code==4136~"1.34mg/ml",
                       prod_code==4303~"3mg",
                       prod_code==4307~"7mg",
                       prod_code==4314~"14mg",
                       prod_code==5745~"3ml",
                       prod_code==5747~"100ml",
                       prod_code==5761~"100ml/33ml",
                       prod_code==6205~"5mg",
                       prod_code==6210~"10mg",
                       prod_code==6225~"2.5mg/1000mg",
                       prod_code==6250~"5mg/500mg",
                       prod_code==6260~"5mg/1000mg",
                       prod_code==6270~"10mg/500mg",
                       prod_code==6280~"10mg/1000mg",
                       prod_code==6512~"250ml",
                       prod_code==6520~"na",
                       prod_code==6524~"na",
                       prod_code==6530~"2mg/.65ml",
                       prod_code==6540~"4mg/.85ml",
                       prod_code==6770~"5mg/5mg",
                       prod_code==6780~"10mg/5mg"),
        days_30=case_when(prod_code==140&pack_code==90~90,
                          prod_code==140&pack_code==30~30,
                          prod_code==141&pack_code==90~90,
                          prod_code==141&pack_code==30~30,
                          prod_code==152&pack_code%in%c(37,30)~30,
                          prod_code==152&pack_code==90~90,
                          prod_code==153&pack_code%in%c(37,30)~30,
                          prod_code==153&pack_code==90~90,
                          prod_code==159&pack_code==18~90,
                          prod_code==159&pack_code==60~30,
                          prod_code==164&pack_code==30~30,
                          prod_code==164&pack_code==34~30,
                          prod_code==164&pack_code==90~90,
                          prod_code==164&pack_code==39~30,
                          prod_code==168&pack_code==60~30,
                          prod_code==168&pack_code==18~90,
                          prod_code==175&pack_code==60~30,
                          prod_code==175&pack_code==18~90,
                          prod_code==180&pack_code==60~30,
                          prod_code==180&pack_code==18~90,
                          prod_code==182&pack_code==30~30,
                          prod_code==182&pack_code==90~90,
                          prod_code==182&pack_code==39~30,
                          prod_code==210&pack_code==8~30,
                          prod_code==210&pack_code==7~30,
                          prod_code==212&pack_code==1~30,
                          prod_code==219&pack_code==4~28,
                          prod_code==280&pack_code==73~30,
                          prod_code==280&pack_code==90~90,
                          prod_code==290&pack_code==59~90,
                          prod_code==290&pack_code==74~30,
                          prod_code==295&pack_code==78~90,
                          prod_code==295&pack_code==88~30,
                          prod_code==300&pack_code==45~30,
                          prod_code==300&pack_code==93~90,
                          prod_code==380&pack_code==13~30,
                          prod_code==380&pack_code==68~90,
                          prod_code==385&pack_code==77~30,
                          prod_code==390&pack_code==71~30,
                          prod_code==390&pack_code==13~90,
                          prod_code==395&pack_code==82~30,
                          prod_code==395&pack_code==23~90,
                          prod_code==540&pack_code==60~30,
                          prod_code==541&pack_code==60~30,
                          prod_code==542&pack_code==60~30,
                          prod_code==543&pack_code==60~30,
                          prod_code==940&pack_code==1~30,
                          prod_code==941&pack_code==1~30,
                          prod_code==942&pack_code==1~30,
                          prod_code==943&pack_code==1~30,
                          prod_code==1427&pack_code==11~30,
                          prod_code==1428&pack_code==11~30,
                          prod_code==1433&pack_code==1~7,
                          prod_code==1433&pack_code==80~28,
                          prod_code==1433&pack_code==61~14,
                          prod_code==1434&pack_code==80~28,
                          prod_code==1434&pack_code==1~14,
                          prod_code==2236&pack_code==1~7,
                          prod_code==2236&pack_code==80~28,
                          prod_code==2800&pack_code==15~10,
                          prod_code==2911&pack_code==15~5,
                          prod_code==3182&pack_code==1~7,
                          prod_code==3182&pack_code==80~28,
                          prod_code==4060&pack_code==13~3,
                          prod_code==4060&pack_code==12~2,
                          prod_code==4130&pack_code==13~7,
                          prod_code==4132&pack_code==12~7,
                          prod_code==4132&pack_code==11~7,
                          prod_code==4136&pack_code==2~14,
                          prod_code==4136&pack_code==11~7,
                          prod_code==4303&pack_code==13~30,
                          prod_code==4307&pack_code==13~30,
                          prod_code==4314&pack_code==13~30,
                          prod_code==5745&pack_code==2~1,
                          prod_code==5747&pack_code==2~2,
                          prod_code==5761&pack_code==5~5,
                          prod_code==6205&pack_code==30~30,
                          prod_code==6210&pack_code==30~30,
                          prod_code==6225&pack_code==60~60,
                          prod_code==6250&pack_code==30~30,
                          prod_code==6260&pack_code==60~60,
                          prod_code==6260&pack_code==30~30,
                          prod_code==6270&pack_code==30~30,
                          prod_code==6280&pack_code==30~30,
                          prod_code==6512&pack_code==1~120,
                          prod_code==6520&pack_code==4~28,
                          prod_code==6524&pack_code==1~7,
                          prod_code==6530&pack_code==4~28,
                          prod_code==6530&pack_code==1~7,
                          prod_code==6540&pack_code==1~7,
                          prod_code==6540&pack_code==4~28,
                          prod_code==6770&pack_code==30~30,
                          prod_code==6780&pack_code==30~30
                          ))]
#manually create days supplied

#notes
#source: https://ndclist.com/ndc/
#210/212 not in ndclist, sourced from https://www.hipaaspace.com/medical_billing/coding/national.drug.codes/66780-210-07
#219 not in ndclist, sourced from https://www.accessdata.fda.gov/drugsatfda_docs/label/2012/022200s000lbl.pdf
#can't locate 226 anywhere, but only 45 units were reimbursed in the entire country. not losing anything for a state-level analysis
#1427/1428 not in ndclist, sourced from https://www.hipaaspace.com/medical_billing/coding/national.drug.codes/0003-1427-11
#6520 https://fda.report/NDC/0310-6520

xw1<-xw[,.(ndc=as.character(ndc),
           lab_code,
           prod_code,
           pack_code,
           prod_name,
           drug_class,
           dose,
           days_supplied=days_30)]
writexl::write_xlsx(xw1,here("trunk","derived","medicaid data","medicaid_days_xw.xlsx"))
  #save to give to MD

xw[,is30:=case_when(days_30%in%c(30,60,90,120)~1,TRUE~0)]
xw<-xw[,.(prod_code,pack_code,days_30,is30,drug_class)]%>%unique()
fwrite(xw,here("trunk","derived","medicaid data","medicaid_days_xw.txt"))

rm(list=ls())
